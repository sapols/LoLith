<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: summonerLookUp.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: summonerLookUp.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>    /**Function uses a hard-coded API Key to pull summoner data for HTML display**/
    var API_KEY2 = "a043453c-dae3-4855-aebc-a4191544f448" //Shawn's Key
    var API_KEY = "5529dcf1-5457-48d2-9c12-eab24c41a382" //Alicia's key
    var enemyNoSpaces;
    var playerNoSpaces;
    var matchWins = []
    
    /**On click function. When submit button is pressed, this executes**/
    $("#submitPlayers").click(function(){
        var enemyName = "";
        var playerName = "";
        var enemyID;
        var playerID;
        //get the names from the user
        playerName = $("#userName").val();
        enemyName = $("#enemyName").val();
        //Change the names to be API friendly (get rid of spaces and uppercase letters)
        enemyNoSpaces = enemyName.replace(/\s/g, "").toLowerCase().trim();
        playerNoSpaces = playerName.replace(/\s/g, "").toLowerCase().trim();

        //Only call the API if the user entered BOTH names.
        if((playerName !== "") &amp;&amp; (enemyName !== "")){
            playerLookUp(playerNoSpaces, enemyNoSpaces);
        }
    });

    /**Call the API to get player info (first text box)**/
    function playerLookUp(name, enemyName){
        //Pulls layer ID and level from API
        $.getJSON("https://na.api.pvp.net/api/lol/na/v1.4/summoner/by-name/" + name + "?api_key=" + API_KEY, function(player){
            playerID = player[name].id;
            $("#sLevel").text(player[name].summonerLevel)
            $("#sID").text(playerID)

            //New JSON request to get player's matchlist
            $.getJSON("https://na.api.pvp.net/api/lol/na/v2.2/matchlist/by-summoner/" + playerID + "?api_key=" + API_KEY, function(playerMatchList){
                var playerMatches = playerMatchList;
                //Once we get the matchlist from the player, do the same for "enemy" player, sending it player matchlist
                enemyLookUp(enemyName, playerMatches, playerID);
            });
            
        });
    }

    /**Call API to get "enemy" info.**/ 
    function enemyLookUp(eName, playerMatches, playerID){
        //get enemy level and ID
        $.getJSON("https://na.api.pvp.net/api/lol/na/v1.4/summoner/by-name/" + eName + "?api_key=" + API_KEY, function(enemy){
            enemyID = enemy[eName].id;
            $("#eLevel").text(enemy[eName].summonerLevel)
            $("#eID").text(enemyID)

            //new JSON request to get enemy matchlist
            $.getJSON("https://na.api.pvp.net/api/lol/na/v2.2/matchlist/by-summoner/" + enemyID + "?api_key=" + API_KEY, function(enemyMatchList){
                var enemyMatches = enemyMatchList.matches;
                var length = enemyMatchList.totalGames;
                
                //holds enemy matches
                var eMatchList = [];
                //holds in common matches
                var inCommon = [];
                
                //add all of the enemy's match ID's to eMatchList
                for(var i = 0; i&lt; length; i++){
                    eMatchList.push(enemyMatches[i].matchId)
                }

                //if the player's match ID is within eMatchList, add it to inCommon
                compareMatchLists(playerMatches, eMatchList, inCommon, playerID, enemyID);
                // player matchlist is a list of game objects, inCommon is a list of common matchIDs btw player1 and player2
                calculateWinPercentage(playerMatches, playerID, inCommon);
            });
        });
    }
    
    /**Calculates the win percentage by determining end result of each game**/
function calculateWinPercentage(playerMatches, playerID, inCommon){
    var wins = 0; 
    var matchesSampled = 0;
    // Iterates over each match in playerMatches, 
    // then iterates over common match sub objects to find if won (not efficient)
    for(var i = 0; i &lt; playerMatches.totalGames; i++){
	setTimeout( function(i){
	 //common match- determine whether player (and teammate) won or lost
        if(inCommon.indexOf(playerMatches.matches[i].matchId) != -1){
	    $.getJSON("https://na.api.pvp.net/api/lol/na/v2.2/match/" + playerMatches.matches[i].matchId + "?api_key=" + API_KEY2, function(datMatch){
            //find player1's participant id for match
            var participantList = datMatch.participantIdentities;
            var playerParticipantID = -1;
            for( j = 0; j &lt; participantList.length; j++ )
            {
                if( participantList[j].player.summonerId == playerID ){
                    playerParticipantID = participantList[j].participantId;
		    break;
                }
            }
            if (playerParticipantID == -1){
                console.log("Unable to find playerid in participant list, call an adult");
		return;
            }
            matchesSampled++;
            //Now we go through participants stat's to find if player was winner
            var participants = datMatch.participants;
            if ( participants[playerParticipantID-1].stats.winner ){
                wins = wins + 1;
            }
            $("#winPercent").text((wins/matchesSampled*100).toPrecision(4) + "%"); 
	    $("#numGamesSampled").text(matchesSampled);
	});
        }
	}, 1100*i, i); 
	// Dorky way to do integer division- wait 10 seconds more per 10 calls to not exceed rate limit
    }
   
}
    /**Function to form an array of all of the matches both players were in**/
    function compareMatchLists(playerMatches, eMatchList, inCommon, playerID, enemyID){
        for(var i = 0; i&lt; playerMatches.totalGames; i++){
            if(eMatchList.indexOf(playerMatches.matches[i].matchId) != -1){
                inCommon.push(playerMatches.matches[i].matchId);
            }
        }
        //REMOVEconsole.log("Setting incommon: " + inCommon)
        determineOpponents(inCommon, playerID, enemyID);
    }

    /**Determines if both players were on the same team**/
    function determineOpponents(inCommon, playerID, enemyID){
        var playerTeam;
        var enemyTeam;
        var whoWon;

        for(var i = 0; i&lt; inCommon.length; i++){
            //dont kill the API!
            if(inCommon.length &lt; 11){
                $.getJSON("https://na.api.pvp.net/api/lol/na/v2.2/match/" + inCommon[i] + "?api_key=" + API_KEY, function(match){
                    console.log("Setting incommon: " + inCommon)
                    for(var i = 0; i &lt; match.participantIdentities.length; i++){
                        if(match.participantIdentities[i].player.summonerId == playerID){
                            var partitipantID = match.participantIdentities[i].participantId;
                            playerTeam = match.participants[partitipantID-1].teamId;
                        }
                        if(match.participantIdentities[i].player.summonerId == enemyID){
                            var partitipantID = match.participantIdentities[i].participantId;
                            enemyTeam = match.participants[partitipantID-1].teamId;
                        }
                    }

                    if(playerTeam == enemyTeam){ /*do nothing*/ }
                    else{
                        if(playerTeam == 100){
                            win(match.teams[0].winner, inCommon.length);
                        }
                        else{
                            win(match.teams[1].winner, inCommon.length);  
                        }
                    }

                    
                });
                if(i == (inCommon.length - 1)){
              //      winPercentage();    
                }
            }
            
        }
    }

    /**Final win percentage **/
    function winPercentage(){
        var win = 0.0;
        var loss = 0.0;
        console.log("Commong: " + matchWins)
        for(var i = 0; i &lt; matchWins.length; i++){
            if(matchWins[i]){
                win += 1.0;
            }
            else{
                loss += 1.0;
            }
        }
        console.log("win: " + win + " loss: " + loss)
        var percent = (win / (win+loss)).toFixed(2) * 100
        $("#winPercent").text(percent+"%");
    }

    function win(isWin, length){
        console.log(isWin)
        console.log("matchwins: " + matchWins)
        if(String(isWin) == "true"){
            matchWins.push(true);
        }
        else{
            matchWins.push(false)
        }

        if(matchWins.length == length){
            winPercentage();
        }
                //console.log("matchwins: " + matchWins)
    }

    /**Append HTML on page to include a table of in-common matches
    //Currently not using, saving for later**/
    function addMatchesToTable(inCommon, matchWins){
        $("#gamelist").append("&lt;tbody>");
        for(var i = 0; i &lt; inCommon.length; i++){
            $("#gamelist").append("&lt;tr>&lt;td>" + inCommon[i] + "&lt;/td>" + "&lt;td>" + matchWins[i] + "&lt;/td>&lt;/tr>");
        }
        $("#gamelist").append("&lt;/tbody>");
    }
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addMatchesToTable">addMatchesToTable</a></li><li><a href="global.html#API_KEY2">API_KEY2</a></li><li><a href="global.html#calculateWinPercentage">calculateWinPercentage</a></li><li><a href="global.html#compareMatchLists">compareMatchLists</a></li><li><a href="global.html#determineOpponents">determineOpponents</a></li><li><a href="global.html#enemyLookUp">enemyLookUp</a></li><li><a href="global.html#playerLookUp">playerLookUp</a></li><li><a href="global.html#winPercentage">winPercentage</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sun Apr 24 2016 23:02:20 GMT-0600 (MDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
